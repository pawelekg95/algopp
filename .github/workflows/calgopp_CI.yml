# Whole CI defined in a single file due to GitHub actions flaw:
# - 'workflow_run' webhook is only triggered when workflow file is already on the default branch (main)
# which does not provide possibility to inspect CI changes on other branches before merging

name: Calgopp_CI
on: [push]
jobs:

# Build stage
  Build_calgopp_tests:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - run: |
          mkdir /tmp/cmake-build-${{ github.sha }}
          cd /tmp/cmake-build-${{ github.sha }}
          cmake ${{ github.workspace }} --preset signal_tests_gcc
          make -j 2

# Test stage
  Calgopp_test:
    needs: Build_calgopp_tests
    runs-on: self-hosted
    steps:
      - run: /tmp/cmake-build-${{ github.sha }}/bin/tests
  Valgrind:
    needs: Build_calgopp_tests
    runs-on: self-hosted
    steps:
      - run: valgrind --leak-check=full --show-leak-kinds=all --error-exitcode=123 --fair-sched=yes /tmp/cmake-build-${{ github.sha }}/bin/tests

# Quality stage
  Clang-format:
    needs: Build_calgopp_tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - run: |
          cd ${{ github.workspace }}
          run-clang-format.py -r lib test
  Clang-tidy:
    needs: Build_calgopp_tests
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - run: |
          cd ${{ github.workspace }}
          mkdir ./cmake-build
          cd ./cmake-build
          cmake .. --preset signal_tests_clang
          run-clang-tidy
